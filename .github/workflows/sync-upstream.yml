# .github/workflows/sync-upstream.yml
# 作用: 定期自动从上游仓库同步最新的代码到你的 Fork 仓库的 main 分支。

name: Sync Upstream

on:
  # 1. 定时触发: 每天 UTC 时间凌晨 2 点 (北京时间上午10点)
  schedule:
    - cron: '0 2 * * *'
  
  # 2. 允许手动从 Actions 页面触发
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # 1. 检出你自己的仓库 (xhy1640/emby-toolkit)
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          # 需要获取所有历史记录以进行合并
          fetch-depth: 0
          # 使用 GITHUB_TOKEN 以获得推送权限
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 设置 Git 用户信息，用于提交记录
      - name: Set Git config
        run: |
          git config --global user.name 'GitHub Actions Sync'
          git config --global user.email 'actions@github.com'

      # 3. 添加上游仓库 (superng6/emby-toolkit) 为远程源
      - name: Add upstream remote
        run: git remote add upstream https://github.com/superng6/emby-toolkit.git

      # 4. 从上游仓库拉取最新的变更
      - name: Fetch from upstream
        run: git fetch upstream

      # 5. 将上游的 main 分支合并到你自己的 main 分支
      # 使用 --ff-only 策略，如果你的 main 分支有自己的修改导致冲突，
      # 合并会失败，工作流会报错，这是一个安全机制。
      - name: Merge upstream/main into main
        run: git merge --ff-only upstream/main

      # 6. 将同步后的代码推送到你的 Fork 仓库
      - name: Push changes to fork
        run: git push origin main
