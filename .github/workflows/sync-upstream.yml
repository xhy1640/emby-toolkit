# 工作流名称
name: Sync Upstream

# 触发工作流的事件
on:
  # 1. 使用 schedule 定时触发，cron 表达式表示每天凌晨2点(UTC时间)执行一次
  schedule:
    - cron: '0 2 * * *'
  
  # 2. 允许手动从 Actions 页面触发此工作流，方便立即同步
  workflow_dispatch:

jobs:
  sync:
    # 使用最新的 Ubuntu 运行环境
    runs-on: ubuntu-latest

    steps:
      # 1. 检出你自己的仓库代码
      # 使用 GITHUB_TOKEN，这样后续的 push 操作才有权限
      - name: Checkout Fork
        uses: actions/checkout@v4
        with:
          # 我们需要获取所有历史记录才能正确地进行合并
          fetch-depth: 0
          # 使用一个有写权限的 token
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 设置 Git 用户信息
      # 这样在同步提交时会显示是 GitHub Actions 机器人操作的
      - name: Set Git config
        run: |
          git config --global user.name 'GitHub Actions Sync'
          git config --global user.email 'actions@github.com'

      # 3. 添加上游仓库为远程源 (remote)
      - name: Add upstream remote
        run: git remote add upstream https://github.com/hbq0405/emby-toolkit.git

      # 4. 从上游仓库拉取最新的变更
      - name: Fetch from upstream
        run: git fetch upstream

      # 5. 合并上游仓库的 main 分支到你自己的 main 分支
      # 使用 --ff-only 确保是一个 "fast-forward" 合并，避免产生不必要的合并提交
      # 如果你的分支有自己的修改且与上游冲突，这一步会失败，这是安全的
      - name: Merge upstream/main into main
        run: git merge --ff-only upstream/main

      # 6. 将更新推送到你的 Fork 仓库
      - name: Push changes to fork
        run: git push origin main
